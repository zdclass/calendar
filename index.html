<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>彰化縣立土庫國民小學 114 學年度第 1 學期行事曆</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
        }
        .calendar-grid {
            grid-template-columns: repeat(7, minmax(0, 1fr));
        }
        .day-cell {
            position: relative;
            padding-top: 100%; /* Aspect ratio 1:1 */
            cursor: pointer;
        }
        .day-content {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .symbol {
            position: absolute;
            bottom: 4px;
            right: 4px;
            font-size: 10px;
            line-height: 1;
        }
        .modal {
            transition: opacity 0.3s ease;
        }
        .tooltip {
            transition: opacity 0.2s ease;
            pointer-events: none;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        @media (max-width: 768px) {
            .symbol {
                bottom: 2px;
                right: 2px;
            }
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-200 transition-colors duration-300">

    <div id="loading-overlay" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-[100]">
        <div class="loader"></div>
    </div>
    
    <!-- Login Modal -->
    <div id="login-modal" class="modal hidden fixed inset-0 z-[70] flex items-center justify-center bg-gray-900 bg-opacity-80">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl w-11/12 md:w-1/3 p-8">
            <h3 class="text-2xl font-bold mb-6 text-center">管理員登入</h3>
            <form id="login-form">
                <div class="mb-4">
                    <label for="login-email" class="block text-sm font-medium text-gray-700 dark:text-gray-300">帳號 (Email)</label>
                    <input type="email" id="login-email" placeholder="請輸入管理員 Email" class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 shadow-sm focus:border-blue-500 focus:ring-blue-500" required>
                </div>
                <div class="mb-6">
                    <label for="login-password" class="block text-sm font-medium text-gray-700 dark:text-gray-300">密碼</label>
                    <input type="password" id="login-password" placeholder="請輸入密碼" class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 shadow-sm focus:border-blue-500 focus:ring-blue-500" required>
                </div>
                <p id="login-error" class="text-red-500 text-sm text-center mb-4 h-5"></p>
                <div class="flex justify-end space-x-3">
                     <button type="button" id="cancel-login-btn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg">取消</button>
                    <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition-colors">登入</button>
                </div>
            </form>
        </div>
    </div>


    <div class="container mx-auto p-4 sm:p-6 lg:p-8">
        <header class="text-center mb-4 relative">
            <h1 class="text-2xl sm:text-3xl lg:text-4xl font-bold text-gray-900 dark:text-white">彰化縣立土庫國民小學</h1>
            <h2 class="text-lg sm:text-xl lg:text-2xl font-semibold text-blue-600 dark:text-blue-400">114 學年度第 1 學期行事曆</h2>
            <div class="absolute top-0 right-0 flex items-center space-x-2">
                 <p id="auth-status" class="text-xs text-gray-500"></p>
                 <button id="login-btn" class="hidden bg-green-500 hover:bg-green-600 text-white font-bold py-1 px-3 rounded-lg transition-colors text-sm">管理員登入</button>
                 <button id="logout-btn" class="hidden bg-gray-500 hover:bg-gray-600 text-white font-bold py-1 px-3 rounded-lg transition-colors text-sm">登出</button>
            </div>
        </header>

        <!-- Today/Tomorrow Events -->
        <section class="my-6 p-4 bg-white dark:bg-gray-800 rounded-xl shadow-lg">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <h3 class="text-lg font-bold text-gray-800 dark:text-white border-b-2 border-blue-500 pb-2 mb-2">今日事項</h3>
                    <div id="today-events" class="text-sm text-gray-600 dark:text-gray-300"></div>
                </div>
                <div>
                    <h3 class="text-lg font-bold text-gray-800 dark:text-white border-b-2 border-green-500 pb-2 mb-2">明日事項</h3>
                    <div id="tomorrow-events" class="text-sm text-gray-600 dark:text-gray-300"></div>
                </div>
            </div>
        </section>

        <main class="flex flex-col lg:flex-row lg:space-x-8">
            <!-- Left Side: Calendars -->
            <div id="calendar-container" class="w-full lg:w-3/5 space-y-8">
                <!-- Calendars will be generated here -->
            </div>

            <!-- Right Side: Events List -->
            <aside class="w-full lg:w-2/5 mt-8 lg:mt-0">
                <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 lg:sticky top-8">
                    <div class="flex justify-between items-center mb-4 border-b-2 border-gray-200 dark:border-gray-700 pb-2">
                        <h3 class="text-2xl font-bold">重要行事</h3>
                        <button id="add-event-btn-main" class="hidden bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg transition-colors">新增</button>
                    </div>
                    <div id="events-list" class="space-y-3 h-[75vh] overflow-y-auto pr-2">
                        <!-- Events will be generated here -->
                    </div>
                </div>
            </aside>
        </main>
    </div>

    <!-- Tooltip -->
    <div id="tooltip" class="tooltip absolute z-50 hidden p-2 text-sm text-white bg-black rounded-md shadow-lg opacity-0 max-w-xs"></div>

    <!-- Day Management Modal -->
    <div id="day-modal" class="modal fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 hidden opacity-0">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl w-11/12 md:w-2/3 lg:w-1/2 max-w-2xl p-6 transform transition-transform scale-95 flex flex-col" style="max-height: 90vh;">
            <div class="flex justify-between items-center border-b pb-3 mb-4 flex-shrink-0">
                <h3 id="modal-date-title" class="text-xl font-bold"></h3>
                <button id="close-day-modal" class="text-gray-500 hover:text-gray-800 dark:hover:text-white text-2xl">&times;</button>
            </div>
            
            <div class="overflow-y-auto mb-4 pr-2 flex-grow">
                <h4 class="text-lg font-semibold mb-2">當日活動列表</h4>
                <div id="modal-events-list" class="space-y-2"></div>
            </div>

            <div id="event-form-container" class="hidden flex-shrink-0 pt-4 border-t">
                <h4 id="form-title" class="text-lg font-semibold mb-3">新增/修改活動</h4>
                <form id="event-form">
                    <input type="hidden" id="event-id">
                    <input type="hidden" id="event-date-hidden">
                    <div class="mb-4">
                        <label for="event-desc" class="block text-sm font-medium text-gray-700 dark:text-gray-300">活動說明</label>
                        <input type="text" id="event-desc" class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 shadow-sm focus:border-blue-500 focus:ring-blue-500" required>
                    </div>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
                         <div>
                            <label for="event-start-date" class="block text-sm font-medium text-gray-700 dark:text-gray-300">開始日期</label>
                            <input type="date" id="event-start-date" class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 shadow-sm focus:border-blue-500 focus:ring-blue-500" required>
                        </div>
                        <div>
                            <label for="event-end-date" class="block text-sm font-medium text-gray-700 dark:text-gray-300">結束日期 (選填)</label>
                            <input type="date" id="event-end-date" class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                        </div>
                    </div>
                    <div class="flex items-center mb-4">
                        <input type="checkbox" id="event-special" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                        <label for="event-special" class="ml-2 block text-sm text-gray-900 dark:text-gray-200">標示為特殊假日/活動</label>
                    </div>
                    <div class="flex justify-end space-x-3">
                        <button type="button" id="cancel-form-btn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg">取消</button>
                        <button type="submit" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg">儲存</button>
                    </div>
                </form>
            </div>
             <div id="add-event-container" class="flex-shrink-0 pt-4 border-t">
                <button id="add-event-modal-btn" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg">新增至此日期</button>
            </div>
        </div>
    </div>
    
    <!-- Confirmation Modal -->
    <div id="confirm-modal" class="modal fixed inset-0 z-[60] flex items-center justify-center bg-black bg-opacity-50 hidden opacity-0">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl w-11/12 md:w-1/3 p-6 transform transition-transform scale-95">
            <h3 id="confirm-title" class="text-lg font-bold mb-4">請確認</h3>
            <p id="confirm-text" class="text-gray-600 dark:text-gray-300 mb-6"></p>
            <div class="flex justify-end space-x-3">
                <button id="confirm-cancel-btn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg">取消</button>
                <button id="confirm-ok-btn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg">確定</button>
            </div>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, doc, addDoc, updateDoc, deleteDoc, getDocs, writeBatch } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // --- Firebase Initialization ---
        let app, auth, db, eventsCollectionRef;
        let firebaseInitialized = false;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // --- App State ---
        let events = [];
        let currentUser = null;
        let unsubscribe = null; 
        let isInitialLoad = true;

        // --- UI Elements ---
        const loadingOverlay = document.getElementById('loading-overlay');
        const calendarContainer = document.getElementById('calendar-container');
        const eventsListContainer = document.getElementById('events-list');
        const tooltip = document.getElementById('tooltip');
        const authStatus = document.getElementById('auth-status');
        const loginBtn = document.getElementById('login-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const addEventBtnMain = document.getElementById('add-event-btn-main');
        const loginModal = document.getElementById('login-modal');
        const loginForm = document.getElementById('login-form');
        const loginError = document.getElementById('login-error');
        const cancelLoginBtn = document.getElementById('cancel-login-btn');
        const dayModal = document.getElementById('day-modal');
        const closeDayModalBtn = document.getElementById('close-day-modal');
        const modalDateTitle = document.getElementById('modal-date-title');
        const modalEventsList = document.getElementById('modal-events-list');
        const eventFormContainer = document.getElementById('event-form-container');
        const eventForm = document.getElementById('event-form');
        const formTitle = document.getElementById('form-title');
        const cancelFormBtn = document.getElementById('cancel-form-btn');
        const addEventModalBtn = document.getElementById('add-event-modal-btn');
        const todayEventsEl = document.getElementById('today-events');
        const tomorrowEventsEl = document.getElementById('tomorrow-events');

        const initialEvents = [
            { date: "2025-09-01", desc: "開學日/備課週開始、上課" }, { date: "2025-09-01", date_end: "2025-09-12", desc: "友善校園週暨反霸凌活動" }, { date: "2025-09-08", desc: "國中第8節輔導課、學習扶助課程及晚自習開始" }, { date: "2025-09-09", date_end: "2025-09-18", desc: "註冊組發放期初程" }, { date: "2025-09-15", date_end: "2025-10-03", desc: "身高體重視力檢查開始" }, { date: "2025-09-16", desc: "一年級環保局家庭廢棄物問卷" }, { date: "2025-09-18", desc: "國家防災日預演" }, { date: "2025-09-19", desc: "國家防災日演練" }, { date: "2025-09-26", desc: "八年級HPV疫苗接種、全校班親會" }, { date: "2025-09-28", desc: "教師節", special: true }, { date: "2025-09-29", desc: "補假 (教師節)", symbol: '■' }, { date: "2025-10-06", desc: "國慶放假", symbol: '■' }, { date: "2025-10-09", desc: "佛光先生舍利講座(五年級)" }, { date: "2025-10-10", desc: "國慶日放假", special: true }, { date: "2025-10-13", symbol: '▲' }, { date: "2025-10-14", date_end: "2025-10-15", desc: "國中第1次定期評量" }, { date: "2025-10-14", desc: "一年級入學測驗(智力)" }, { date: "2025-10-14", desc: "四年級參觀人口政策計畫" }, { date: "2025-10-16", desc: "十年級抽血檢查" }, { date: "2025-10-16", date_end: "2025-10-17", desc: "九年級畢旅" }, { date: "2025-10-20", date_end: "2025-10-31", desc: "國中小藝術季布置(國中美術)" }, { date: "2025-10-21", desc: "全校流感疫苗接種" }, { date: "2025-10-24", desc: "補假" }, { date: "2025-10-25", desc: "光復節放假", special: true }, { date: "2025-10-27", desc: "作業抽查(國中社會)" }, { date: "2025-10-28", desc: "作業抽查(國小中年級)" }, { date: "2025-10-29", desc: "七年級抽血檢查" }, { date: "2025-11-01", desc: "親職講座" }, { date: "2025-11-04", desc: "作業抽查(國中小英文)(11/12國小英文)" }, { date: "2025-11-05", date_end: "2025-11-06", desc: "國小第1次定期評量" , symbol_start: '▼', symbol_end: '□' }, { date: "2025-11-06", date_end: "2025-11-07", desc: "九年級心理測驗參考" }, { date: "2025-11-07", desc: "一、四、七年級健康檢查" }, { date: "2025-11-18", desc: "國小一、六年級戶外教育" }, { date: "2025-11-21", desc: "作業抽查(國中自然)" }, { date: "2025-11-26", desc: "作業抽查(國中數學、八年級聯絡簿)" }, { date: "2025-11-26", desc: "吃水果日/發放通知" }, { date: "2025-11-30", symbol: '▲' }, { date: "2025-12-01", date_end: "2025-12-02", desc: "國中第2次定期評量", symbol_end: '▼' }, { date: "2025-12-03", desc: "作業抽查(國小國語)", symbol: '□' }, { date: "2025-12-03", desc: "藝文競賽(才藝子弟)書法、繪畫及作文" }, { date: "2025-12-10", desc: "國小英語朗讀比賽" }, { date: "2025-12-13", desc: "校慶運動會", special: true }, { date: "2025-12-15", desc: "校慶補假", symbol: '■' }, { date: "2025-12-17", desc: "作業抽查(國小自然)" }, { date: "2025-12-21", symbol: '▲' }, { date: "2025-12-23", desc: "藝文競賽(演講、朗讀及說故事)" }, { date: "2025-12-23", date_end: "2025-12-24", desc: "九年級技藝班術科抽離會考" }, { date: "2025-12-24", desc: "作業抽查(國中自習)", symbol: '■' }, { date: "2025-12-25", desc: "行憲紀念日放假", symbol: '□' }, { date: "2025-12-31", desc: "國中小藝術季開幕才藝表演" }, { date: "2025-12-31", desc: "九年級聯絡簿抽查" }, { date: "2026-01-01", desc: "元旦放假", special: true, symbol: '□' }, { date: "2026-01-02", symbol: '■' }, { date: "2026-01-05", date_end: "2026-01-09", desc: "國中美術才藝換商品卡" }, { date: "2026-01-08", desc: "校內本土語文競賽" }, { date: "2026-01-09", desc: "作業抽查(國小作文)" }, { date: "2026-01-12", symbol: '▲' }, { date: "2026-01-13", date_end: "2026-01-14", desc: "國小第2次定期評量" }, { date: "2026-01-15", date_end: "2026-01-16", desc: "國中第3次定期評量", symbol_start: '▼', symbol_end: '□' }, { date: "2026-01-19", symbol: '▲' }, { date: "2026-01-20", desc: "休業式", symbol: '▼' }, { date: "2026-01-21", date_end: "2026-01-23", desc: "補下學期課程" }, { date: "2026-01-24", desc: "放寒假", special: true }
        ];

        // --- Core Functions ---
        const rerender = () => {
            if (!document.body.contains(calendarContainer)) return; // Ensure elements exist
            calendarContainer.innerHTML = '';
            eventsListContainer.innerHTML = '';

            const eventMap = new Map();
            events.forEach(event => {
                // Use UTC dates to avoid timezone issues
                const startDate = new Date(event.date + 'T00:00:00Z');
                const endDate = event.date_end ? new Date(event.date_end + 'T00:00:00Z') : startDate;
                for (let d = new Date(startDate); d <= endDate; d.setUTCDate(d.getUTCDate() + 1)) {
                    const dateString = d.toISOString().split('T')[0];
                    if (!eventMap.has(dateString)) eventMap.set(dateString, []);
                    eventMap.get(dateString).push(event);
                }
            });
            renderTodayTomorrow(eventMap);
            renderCalendars(eventMap);
            renderEventsList();
        };

        function setupApp() {
            try {
                const firebaseConfig = {
                    apiKey: "__API_KEY__",
                    authDomain: "__AUTH_DOMAIN__",
                    projectId: "__PROJECT_ID__",
                    storageBucket: "__STORAGE_BUCKET__",
                    messagingSenderId: "__MESSAGING_SENDER_ID__",
                    appId: "__APP_ID__",
                    measurementId: "__MEASUREMENT_ID__"
                };

                if (firebaseConfig.apiKey.startsWith("__")) {
                    throw new Error("Firebase config placeholders not replaced. Run this through the GitHub Actions workflow.");
                }

                console.log("Initializing Firebase with Project ID:", firebaseConfig.projectId);
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                eventsCollectionRef = collection(db, "artifacts", appId, "public/data", "events");
                firebaseInitialized = true;
                
            } catch (e) {
                console.error("Firebase Initialization Error:", e.message);
                firebaseInitialized = false;
            }

            // Always setup listener, it will handle fallback
            setupSnapshotListener();

            // Setup Auth listener
            if (firebaseInitialized) {
                onAuthStateChanged(auth, handleAuthStateChange);
            } else {
                handleAuthStateChange(null); // Force guest mode
            }
        }

        function handleAuthStateChange(user) {
            if (user) {
                currentUser = user;
                authStatus.textContent = `管理員已登入`;
                loginBtn.classList.add('hidden');
                logoutBtn.classList.remove('hidden');
                addEventBtnMain.classList.remove('hidden');

                // Check and seed data only after admin logs in
                seedInitialDataIfNeeded();
            } else {
                currentUser = null;
                authStatus.textContent = '訪客模式';
                loginBtn.classList.remove('hidden');
                logoutBtn.classList.add('hidden');
                addEventBtnMain.classList.add('hidden');
            }
            rerender();
        }

        function setupSnapshotListener() {
            loadingOverlay.style.display = 'flex';

            if (!firebaseInitialized) {
                console.warn("Firebase not initialized. Falling back to local initialEvents data.");
                events = initialEvents;
                rerender();
                if (isInitialLoad) {
                    scrollToCurrentMonth();
                    isInitialLoad = false;
                }
                loadingOverlay.style.display = 'none';
                return;
            }
            
            if (unsubscribe) unsubscribe();

            unsubscribe = onSnapshot(eventsCollectionRef, (snapshot) => {
                events = [];
                snapshot.forEach((doc) => {
                    events.push({ id: doc.id, ...doc.data() });
                });

                if (snapshot.empty && !currentUser) {
                    // DB is empty and user is a guest, use local data as fallback
                    events = initialEvents;
                }
                
                rerender();

                if (isInitialLoad) {
                    scrollToCurrentMonth();
                    isInitialLoad = false;
                }

                loadingOverlay.style.display = 'none';
            }, (error) => {
                console.error("Error fetching events from Firestore:", error.message);
                // Fallback to local data on permission error for guests
                events = initialEvents;
                rerender();
                if (isInitialLoad) {
                    scrollToCurrentMonth();
                    isInitialLoad = false;
                }
                loadingOverlay.style.display = 'none';
            });
        }
        
        async function seedInitialDataIfNeeded() {
            if (!firebaseInitialized || !currentUser) return;
            try {
                const querySnapshot = await getDocs(eventsCollectionRef);
                if (querySnapshot.empty) {
                    console.log("Database is empty. Seeding initial data as admin...");
                    const batch = writeBatch(db);
                    initialEvents.forEach(event => {
                        const docRef = doc(eventsCollectionRef);
                        batch.set(docRef, event);
                    });
                    await batch.commit();
                    console.log("Initial data seeded successfully.");
                }
            } catch (err) {
                console.error("Error during admin's data seed check:", err);
            }
        }
        
        function scrollToCurrentMonth() {
            const today = new Date();
            const currentYear = today.getFullYear();
            const currentMonth = today.getMonth(); // 0-11
            
            const startYear = 2025, startMonth = 8; // September is 8
            const endYear = 2026, endMonth = 0; // January is 0

            let targetYear = currentYear;
            let targetMonth = currentMonth;

            // Clamp the date to the calendar's display range
            if (targetYear < startYear || (targetYear === startYear && targetMonth < startMonth)) {
                targetYear = startYear;
                targetMonth = startMonth;
            } else if (targetYear > endYear || (targetYear === endYear && targetMonth > endMonth)) {
                targetYear = endYear;
                targetMonth = endMonth;
            }

            const targetId = `month-${targetYear}-${targetMonth}`;
            const targetElement = document.getElementById(targetId);

            if (targetElement) {
                setTimeout(() => {
                    targetElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }, 200);
            }
        }

        function renderTodayTomorrow(eventMap) {
            const today = new Date();
            const tomorrow = new Date();
            tomorrow.setDate(today.getDate() + 1);

            const todayString = today.toISOString().split('T')[0];
            const tomorrowString = tomorrow.toISOString().split('T')[0];

            const todayEvents = eventMap.get(todayString) || [];
            const tomorrowEvents = eventMap.get(tomorrowString) || [];

            todayEventsEl.innerHTML = todayEvents.length > 0 
                ? todayEvents.map(e => `<div>- ${e.desc}</div>`).join('') 
                : '<p>無</p>';
            tomorrowEventsEl.innerHTML = tomorrowEvents.length > 0 
                ? tomorrowEvents.map(e => `<div>- ${e.desc}</div>`).join('') 
                : '<p>無</p>';
        }

        function renderCalendars(eventMap) {
            const startYear = 2025, startMonth = 8, endYear = 2026, endMonth = 0;
            for (let y = startYear; y <= endYear; y++) {
                const mStart = (y === startYear) ? startMonth : 0;
                const mEnd = (y === endYear) ? endMonth : 11;
                for (let m = mStart; m <= mEnd; m++) {
                    renderMonth(y, m, eventMap);
                }
            }
        }
        
        function renderMonth(year, month, eventMap) {
            const monthContainer = document.createElement('div');
            monthContainer.id = `month-${year}-${month}`;
            monthContainer.className = 'bg-white dark:bg-gray-800 p-4 sm:p-6 rounded-xl shadow-lg';
            const monthName = new Date(year, month).toLocaleString('zh-Hant', { month: 'long', year: 'numeric' });
            const daysOfWeek = ['日', '一', '二', '三', '四', '五', '六'];
            let headerHTML = `<h3 class="text-xl font-bold text-center mb-4">${monthName}</h3><div class="grid calendar-grid gap-1 text-sm font-semibold text-center text-gray-500 dark:text-gray-400 mb-2">${daysOfWeek.map(d=>`<div>${d}</div>`).join('')}</div>`;
            monthContainer.innerHTML = headerHTML;
            const bodyEl = document.createElement('div');
            bodyEl.className = 'grid calendar-grid gap-1';
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            for (let i = 0; i < firstDay; i++) bodyEl.appendChild(document.createElement('div'));

            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(Date.UTC(year, month, day));
                const dateString = date.toISOString().split('T')[0];
                const dayEvents = eventMap.get(dateString) || [];
                const cellEl = document.createElement('div');
                cellEl.className = 'day-cell rounded-lg text-sm transition-colors duration-200';
                const contentEl = document.createElement('div');
                contentEl.className = 'day-content rounded-lg';
                contentEl.textContent = day;

                if (dayEvents.length > 0) {
                    const hasSpecial = dayEvents.some(e => e.special);
                    if (hasSpecial) {
                        contentEl.classList.add('bg-red-100', 'dark:bg-red-900', 'text-red-600', 'dark:text-red-300', 'font-bold');
                    } else {
                        contentEl.classList.add('bg-blue-100', 'dark:bg-blue-800');
                    }
                    cellEl.addEventListener('mouseenter', (e) => showTooltip(dayEvents, e));
                    cellEl.addEventListener('mousemove', (e) => updateTooltipPosition(e));
                    cellEl.addEventListener('mouseleave', hideTooltip);
                    let symbolHTML = '';
                    dayEvents.forEach(e => {
                        if(e.date === dateString && e.symbol) symbolHTML = `<span class="symbol">${e.symbol}</span>`;
                        if(e.date === dateString && e.symbol_start) symbolHTML = `<span class="symbol">${e.symbol_start}</span>`;
                        if(e.date_end === dateString && e.symbol_end) symbolHTML = `<span class="symbol">${e.symbol_end}</span>`;
                    });
                    contentEl.innerHTML += symbolHTML;
                } else {
                    cellEl.classList.add('hover:bg-gray-100', 'dark:hover:bg-gray-700');
                }
                cellEl.addEventListener('click', () => showDayModal(dateString, dayEvents));
                cellEl.appendChild(contentEl);
                bodyEl.appendChild(cellEl);
            }
            monthContainer.appendChild(bodyEl);
            calendarContainer.appendChild(monthContainer);
        }

        function renderEventsList() {
            eventsListContainer.innerHTML = '';
            const sortedEvents = events.filter(e => e.desc).sort((a,b) => new Date(a.date) - new Date(b.date));

            sortedEvents.forEach(event => {
                const eventElement = document.createElement('div');
                eventElement.className = 'flex items-center space-x-3 p-2 rounded-lg';
                const startDate = new Date(event.date + 'T00:00:00Z');
                let dateText = event.date_end 
                    ? `${startDate.getUTCMonth()+1}/${startDate.getUTCDate()}-${new Date(event.date_end+'T00:00:00Z').getUTCMonth()+1}/${new Date(event.date_end+'T00:00:00Z').getUTCDate()}` 
                    : `${startDate.getUTCMonth()+1}/${startDate.getUTCDate()}`;
                
                let buttonsHTML = '';
                if (currentUser) {
                    buttonsHTML = `<div class="flex-shrink-0 flex space-x-2"></div>`;
                }

                eventElement.innerHTML = `
                    <div class="w-24 text-right flex-shrink-0"><span class="font-semibold ${event.special ? 'text-red-500' : 'text-blue-600 dark:text-blue-400'}">${dateText}</span></div>
                    <div class="flex-grow text-gray-700 dark:text-gray-300">${event.desc}</div>
                    ${buttonsHTML}`;
                
                eventsListContainer.appendChild(eventElement);
            });
        }
        
        // --- Event Handlers & UI Logic ---
        document.addEventListener('DOMContentLoaded', setupApp);
        loginBtn.addEventListener('click', () => { loginForm.reset(); loginError.textContent = ''; openModal(loginModal); });
        cancelLoginBtn.addEventListener('click', () => closeModal(loginModal));
        logoutBtn.addEventListener('click', () => { if(firebaseInitialized) signOut(auth); });
        addEventBtnMain.addEventListener('click', () => showDayModal(new Date().toISOString().split('T')[0], []));

        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!firebaseInitialized) {
                loginError.textContent = 'Firebase 未初始化。';
                return;
            }
            loginError.textContent = '';
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            const submitButton = e.target.querySelector('button[type="submit"]');
            submitButton.disabled = true;
            submitButton.textContent = '登入中...';
            try {
                await signInWithEmailAndPassword(auth, email, password);
                closeModal(loginModal);
            } catch (error) {
                if (error.code === 'auth/invalid-credential' || error.code === 'auth/wrong-password' || error.code === 'auth/user-not-found') {
                    loginError.textContent = '帳號或密碼錯誤。';
                } else {
                    loginError.textContent = '登入時發生錯誤。';
                }
            } finally {
                submitButton.disabled = false;
                submitButton.textContent = '登入';
            }
        });

        const showDayModal = (dateString, dayEvents) => {
            const date = new Date(dateString + 'T00:00:00Z');
            modalDateTitle.textContent = date.toLocaleDateString('zh-Hant', { year: 'numeric', month: 'long', day: 'numeric', timeZone: 'UTC' });
            document.getElementById('event-date-hidden').value = dateString;
            
            modalEventsList.innerHTML = '';
            const filteredEvents = dayEvents.filter(ev => ev.desc);
            if (filteredEvents.length > 0) {
                filteredEvents.forEach(ev => {
                    const p = document.createElement('div');
                    p.className = 'p-2 rounded-md bg-gray-100 dark:bg-gray-700 flex justify-between items-center';
                    p.innerHTML = `<span>${ev.desc}</span>`;

                    if (currentUser) {
                        const buttonsDiv = document.createElement('div');
                        buttonsDiv.className = 'space-x-2';
                        const editBtn = document.createElement('button');
                        editBtn.textContent = '編輯';
                        editBtn.className = 'text-xs text-blue-500 hover:text-blue-700';
                        editBtn.onclick = () => showEditForm(ev);
                        
                        const deleteBtn = document.createElement('button');
                        deleteBtn.textContent = '刪除';
                        deleteBtn.className = 'text-xs text-red-500 hover:text-red-700';
                        deleteBtn.onclick = () => deleteEvent(ev.id);
                        
                        buttonsDiv.appendChild(editBtn);
                        buttonsDiv.appendChild(deleteBtn);
                        p.appendChild(buttonsDiv);
                    }
                    modalEventsList.appendChild(p);
                });
            } else {
                modalEventsList.innerHTML = '<p class="text-gray-500">本日無特殊行程</p>';
            }

            // Reset and hide form initially
            eventFormContainer.classList.add('hidden');
            if(currentUser) {
                addEventModalBtn.classList.remove('hidden');
                addEventContainer.style.display = 'block';
            } else {
                addEventModalBtn.classList.add('hidden');
                addEventContainer.style.display = 'none';
            }
            openModal(dayModal);
        };

        const addEventContainer = document.getElementById('add-event-container');
        addEventModalBtn.addEventListener('click', () => {
            const dateString = document.getElementById('event-date-hidden').value;
            eventForm.reset();
            document.getElementById('event-id').value = '';
            document.getElementById('event-start-date').value = dateString;
            formTitle.textContent = '新增活動';
            eventFormContainer.classList.remove('hidden');
            addEventContainer.style.display = 'none';
        });

        function showEditForm(event) {
            formTitle.textContent = '修改活動';
            document.getElementById('event-id').value = event.id;
            document.getElementById('event-desc').value = event.desc || '';
            document.getElementById('event-start-date').value = event.date;
            document.getElementById('event-end-date').value = event.date_end || '';
            document.getElementById('event-special').checked = event.special || false;
            eventFormContainer.classList.remove('hidden');
            addEventContainer.style.display = 'none';
        }

        closeDayModalBtn.addEventListener('click', () => closeModal(dayModal));
        cancelFormBtn.addEventListener('click', () => {
            eventFormContainer.classList.add('hidden');
            if(currentUser) addEventContainer.style.display = 'block';
        });

        eventForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if(!currentUser || !firebaseInitialized) return;
            const id = document.getElementById('event-id').value;
            const eventData = {
                desc: document.getElementById('event-desc').value.trim(),
                date: document.getElementById('event-start-date').value,
                date_end: document.getElementById('event-end-date').value || null,
                special: document.getElementById('event-special').checked,
            };

            if (!eventData.desc || !eventData.date) {
                alert("活動說明和開始日期為必填項。");
                return;
            }

            const submitButton = e.target.querySelector('button[type="submit"]');
            submitButton.disabled = true;

            try {
                if (id) {
                    await updateDoc(doc(eventsCollectionRef, id), eventData);
                } else {
                    await addDoc(eventsCollectionRef, eventData);
                }
                closeModal(dayModal);
            } catch (err) {
                console.error("Error saving event:", err);
                alert("儲存失敗，請稍後再試。");
            } finally {
                submitButton.disabled = false;
            }
        });
        
        const deleteEvent = async (id) => {
            if(!currentUser || !firebaseInitialized) return;
            const confirmed = await showConfirm('您確定要刪除這個活動嗎？');
            if (confirmed) {
                try {
                    await deleteDoc(doc(eventsCollectionRef, id));
                    closeModal(dayModal);
                } catch (err) {
                    console.error("Error deleting event:", err);
                    alert("刪除失敗，請稍後再試。");
                }
            }
        };

        const showTooltip = (dayEvents, e) => { const eventDescs = dayEvents.map(ev => ev.desc).filter(Boolean).join('<br>'); if (!eventDescs) return; tooltip.innerHTML = eventDescs; tooltip.classList.remove('hidden', 'opacity-0'); updateTooltipPosition(e); };
        const hideTooltip = () => tooltip.classList.add('hidden', 'opacity-0');
        const updateTooltipPosition = (e) => { tooltip.style.left = `${e.pageX + 15}px`; tooltip.style.top = `${e.pageY + 15}px`; };
        const openModal = (modal) => { modal.classList.remove('hidden'); setTimeout(() => { modal.classList.remove('opacity-0'); if (modal.querySelector('div:first-child')) { modal.querySelector('div:first-child').classList.remove('scale-95'); } }, 10); };
        const closeModal = (modal) => { modal.classList.add('opacity-0'); if (modal.querySelector('div:first-child')) { modal.querySelector('div:first-child').classList.add('scale-95'); } setTimeout(() => modal.classList.add('hidden'), 300); };
        
        const confirmModal = document.getElementById('confirm-modal'); const confirmOkBtn = document.getElementById('confirm-ok-btn'); const confirmCancelBtn = document.getElementById('confirm-cancel-btn'); const confirmTitle = document.getElementById('confirm-title'); const confirmText = document.getElementById('confirm-text'); let resolveConfirm; function showConfirm(text, title = '請確認') { confirmTitle.textContent = title; confirmText.textContent = text; openModal(confirmModal); return new Promise((resolve) => { resolveConfirm = resolve; }); }
        confirmOkBtn.addEventListener('click', () => { closeModal(confirmModal); if (resolveConfirm) resolveConfirm(true); });
        confirmCancelBtn.addEventListener('click', () => { closeModal(confirmModal); if (resolveConfirm) resolveConfirm(false); });

    </script>
</body>
</html>

